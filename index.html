<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>數資中心資料確認系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0;
      font-family: 'Noto Sans TC', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #e0f2fe, #fef9c3);
      color: #000;
    }
    .glass {
      backdrop-filter: blur(18px);
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 15px 40px rgba(0,0,0,0.1);
      animation: fadeInUp 0.8s ease forwards;
      opacity: 0; transform: translateY(30px);
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }
    #signature {
      touch-action: none;
      border: 1px solid #ccc; background: #fff;
      display: block;
      width: 100%; height: auto;
      border-radius: 8px;
    }
    .toast {
      transition: transform 0.3s, opacity 0.3s;
      transform: translateX(100%); opacity: 0;
    }
    .toast-show { transform: translateX(0); opacity: 1; }
    #fileList li {
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.75);
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    #fileList li:hover {
      background: rgba(255,255,255,0.95);
    }
  </style>
</head>

<body class="flex items-center justify-center">

  <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <div class="glass w-full max-w-2xl p-8 rounded-2xl space-y-6">
    <h1 class="text-3xl font-bold text-indigo-700 text-center mb-4">數資中心資料確認系統</h1>

    <!-- 登入畫面 -->
    <div id="loginView" class="space-y-4">
      <input id="empId" placeholder="員工編號"
        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-300"/>
      <input id="empPw" type="password" placeholder="密碼"
        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-300"/>
      <button onclick="login()" 
        class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-500 transition">
        登入
      </button>
      <p id="loginMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- 首次登入變更密碼 -->
    <div id="changePwView" class="hidden space-y-4">
      <input id="oldPw" type="password" placeholder="舊密碼"
        class="w-full border border-gray-300 p-3 rounded-lg"/>
      <input id="newPw" type="password" placeholder="新密碼"
        class="w-full border border-gray-300 p-3 rounded-lg"/>
      <button onclick="changePassword()" 
        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-500 transition">
        變更密碼
      </button>
      <p id="pwMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- 主畫面 -->
    <div id="mainView" class="hidden space-y-6">
      <div class="flex items-center justify-between">
        <p class="text-lg font-bold">部門：<span id="dept" class="text-blue-700"></span> 
          / 職稱：<span id="title" class="text-pink-700"></span>
          / 姓名：<span id="empName" class="text-green-700"></span>
        </p>
        <button onclick="logout()"
          class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-400 transition">
          登出
        </button>
      </div>

      <!-- 檔案類型切換 + 檔案清單 -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-bold mb-2">檔案清單</h2>
        <div class="flex gap-2 mb-2">
          <button id="pdfBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded"
            onclick="renderFileList('pdf')">
            PDF(0)
          </button>
          <button id="wordBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded"
            onclick="renderFileList('word')">
            Word(0)
          </button>
          <button id="othersBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded"
            onclick="renderFileList('others')">
            Others(0)
          </button>
          <button class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded"
            onclick="renderFileList('all')">
            All
          </button>
        </div>
        <ul id="fileList" class="text-sm space-y-2">
          <li class="text-gray-500">載入中...</li>
        </ul>
      </div>

      <!-- 簽名區 -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-bold mb-2">簽名區</h2>
        <canvas id="signature"></canvas>
        <div class="flex justify-between mt-4">
          <button onclick="clearPad()"
            class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">
            清除
          </button>
          <button id="submitBtn" onclick="submitSignature()"
            class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-500 transition">
            送出簽名
          </button>
        </div>
        <p id="result" class="mt-4 text-center text-green-700 text-sm font-medium"></p>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
  const api = 'https://script.google.com/macros/s/.../exec'; 
  // ★ 上面要換成你新部署的 Apps Script 網址 (macros/s/xxx/exec)
  
  let userToken='', folderId='', currentFileList=[];
  let isSubmitting=false;

  /*****************************************************
   * Toast
  *****************************************************/
  function showToast(msg, success=true){
    const container=document.getElementById('toastContainer');
    const toast=document.createElement('div');
    toast.className=`
      toast px-4 py-2 rounded shadow-lg mb-2 
      ${success?'bg-green-500':'bg-red-500'} 
      text-white
    `;
    toast.textContent=msg;
    container.appendChild(toast);

    requestAnimationFrame(()=>{toast.classList.add('toast-show');});
    setTimeout(()=>{
      toast.classList.remove('toast-show');
      setTimeout(()=>{
        if(toast.parentNode) toast.parentNode.removeChild(toast);
      },300);
    },2000);
  }

  /*****************************************************
   * login
  *****************************************************/
  function login(){
    const id=empId.value.trim();
    const pw=empPw.value.trim();
    fetch(api+'/',{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({
        action:'login',
        employeeId:id,
        password:pw
      })
    })
      .then(r=>r.json())
      .then(data=>{
        if(data.success){
          if(data.needPasswordChange){
            loginView.classList.add('hidden');
            changePwView.classList.remove('hidden');
          } else {
            loginView.classList.add('hidden');
            mainView.classList.remove('hidden');
            dept.textContent=data.department||'';
            title.textContent=data.title||'';
            empName.textContent=data.name||'';
            folderId=data.folderId;
            loadFileList();
            setTimeout(initSignatureCanvas,150);
            showToast('✅ 登入成功！');
          }
        } else {
          showToast(data.message,false);
          loginMsg.textContent=data.message;
        }
      })
      .catch(e=>{
        showToast('❌ login API 發生問題',false);
      });
  }

  /*****************************************************
   * changePassword
  *****************************************************/
  function changePassword(){
    const id=empId.value.trim();
    const oldPw=oldPw.value.trim();
    const newPw=newPw.value.trim();
    fetch(api+'/',{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({
        action:'changePassword',
        employeeId:id,
        oldPassword:oldPw,
        newPassword:newPw
      })
    })
      .then(r=>r.json())
      .then(data=>{
        if(data.success){
          alert('密碼變更成功，請重新登入');
          location.reload();
        } else {
          pwMsg.textContent=data.message;
          showToast(data.message,false);
        }
      })
      .catch(e=>{
        showToast('❌ changePassword API 發生問題',false);
      });
  }

  /*****************************************************
   * loadFileList => 抓所有檔案 + extension
  *****************************************************/
  function loadFileList(){
    fetch(`${api}/?action=getFileList&folderId=${folderId}`)
      .then(r=>r.json())
      .then(data=>{
        currentFileList=data.files||[];
        // 統計pdf/word/others
        let pdfCount=0, wordCount=0, othersCount=0;
        currentFileList.forEach(f=>{
          if(f.extension==='pdf') pdfCount++;
          else if(['doc','docx','gdoc'].includes(f.extension)) wordCount++;
          else othersCount++;
        });
        pdfBtn.textContent=`PDF(${pdfCount})`;
        wordBtn.textContent=`Word(${wordCount})`;
        othersBtn.textContent=`Others(${othersCount})`;

        renderFileList('all'); // 初始顯示全部
      })
      .catch(e=>{
        showToast('❌ getFileList API 發生問題',false);
      });
  }

  /*****************************************************
   * renderFileList => pdf/word/others/all
  *****************************************************/
  function renderFileList(category){
    fileList.innerHTML='';
    let filtered=currentFileList.filter(f=>{
      if(category==='all') return true;
      if(category==='pdf') return (f.extension==='pdf');
      if(category==='word') return (['doc','docx','gdoc'].includes(f.extension));
      return !(['pdf','doc','docx','gdoc'].includes(f.extension));
    });

    if(filtered.length===0){
      let li=document.createElement('li');
      li.textContent='(無檔案)';
      li.className='text-gray-500';
      fileList.appendChild(li);
    } else {
      filtered.forEach(f=>{
        let li=document.createElement('li');
        li.textContent=`${f.name}（${f.date}）`;
        fileList.appendChild(li);
      });
    }
  }

  /*****************************************************
   * 簽名畫布
  *****************************************************/
  function initSignatureCanvas(){
    const c=signature;
    const ctx=c.getContext('2d');
    let drawing=false, lastX=0,lastY=0;

    function resizeCanvas(){
      const dpr=window.devicePixelRatio||1;
      const w=c.offsetWidth;
      let ratio=window.innerWidth<768?0.55:0.33;
      const h=Math.floor(w*ratio);

      c.width=w*dpr;
      c.height=h*dpr;
      c.style.height=h+'px';
      c.style.width=w+'px';
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr,dpr);
    }
    resizeCanvas();
    window.addEventListener('resize',resizeCanvas);

    function getOffset(e){
      const rect=c.getBoundingClientRect();
      if(e.touches?.[0]){
        return [ e.touches[0].clientX-rect.left, e.touches[0].clientY-rect.top ];
      } else {
        return [ e.offsetX,e.offsetY ];
      }
    }
    function startDraw(e){
      drawing=true;
      let [x,y]=getOffset(e);
      ctx.beginPath();
      ctx.moveTo(x,y);
      [lastX,lastY]=[x,y];
    }
    function draw(e){
      if(!drawing)return;
      let [x,y]=getOffset(e);
      ctx.lineTo(x,y);
      ctx.strokeStyle='#000';
      ctx.lineWidth=2;
      ctx.lineCap='round';
      ctx.stroke();
      [lastX,lastY]=[x,y];
    }
    function endDraw(){ drawing=false; }

    c.addEventListener('mousedown',startDraw);
    c.addEventListener('mousemove',draw);
    c.addEventListener('mouseup',endDraw);
    c.addEventListener('mouseleave',endDraw);

    c.addEventListener('touchstart',ev=>{
      ev.preventDefault();
      startDraw(ev);
    },{passive:false});
    c.addEventListener('touchmove',ev=>{
      ev.preventDefault();
      draw(ev);
