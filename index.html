<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ•¸ä½ç°½æ ¸ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
  <div class="min-h-screen flex flex-col items-center justify-center px-4 py-8">
    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-2xl space-y-6">
      <h2 class="text-2xl font-bold text-center text-gray-800">ğŸ” å“¡å·¥ç™»å…¥ç³»çµ±</h2>

      <!-- ç™»å…¥å€ -->
      <div id="login-section">
        <input id="employeeId" class="w-full border px-3 py-2 rounded mt-2" placeholder="å“¡å·¥ç·¨è™Ÿ (å¦‚ CC0384)">
        <input id="password" class="w-full border px-3 py-2 rounded mt-2" type="password" placeholder="å¯†ç¢¼">
        <button onclick="login()" class="bg-blue-600 hover:bg-blue-500 w-full text-white py-2 rounded font-bold mt-4">ç™»å…¥</button>
      </div>

      <!-- é¦–æ¬¡ç™»å…¥è®Šæ›´å¯†ç¢¼å€ -->
      <div id="change-password-section" class="hidden">
        <p class="text-sm text-gray-600 mb-2">é¦–æ¬¡ç™»å…¥ï¼Œè«‹è®Šæ›´å¯†ç¢¼ï¼š</p>
        <input id="newPassword" class="w-full border px-3 py-2 rounded mt-2" type="password" placeholder="æ–°å¯†ç¢¼">
        <button onclick="changePassword()" class="bg-yellow-500 hover:bg-yellow-400 w-full text-white py-2 rounded font-bold mt-4">è®Šæ›´å¯†ç¢¼</button>
      </div>

      <!-- ç™»å…¥æˆåŠŸå€ -->
      <div id="signed-section" class="hidden space-y-4">
        <div>
          <p class="text-sm text-gray-800">âœ… ç™»å…¥æˆåŠŸï¼éƒ¨é–€ï¼š<span id="department"></span></p>
        </div>
        <div>
          <h3 class="text-sm font-bold text-gray-600 mb-1">ğŸ“„ PDF æ¸…å–®</h3>
          <ul id="fileList" class="text-sm space-y-1 text-gray-700"></ul>
        </div>
        <div>
          <h3 class="text-sm font-bold text-gray-600 mb-1">âœï¸ ç°½åå€</h3>
          <canvas id="signature" class="border bg-white rounded shadow" width="500" height="150"></canvas>
          <div class="flex gap-4 mt-2">
            <button onclick="clearPad()" class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-1 rounded">æ¸…é™¤</button>
            <button onclick="submitSignature()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-1 rounded">é€å‡ºç°½å</button>
          </div>
        </div>
        <p id="result" class="text-green-600 font-bold"></p>
      </div>
    </div>
  </div>

  <script>
    const gasUrl = "https://aged-lake-0db4.chiachun12171217.workers.dev";
    let currentEmployeeId = "";
    let currentPassword = "";
    let currentDepartment = "";
    let currentFolderId = "";

    function login() {
      const employeeId = document.getElementById("employeeId").value.trim();
      const password = document.getElementById("password").value.trim();
      currentEmployeeId = employeeId;
      currentPassword = password;

      fetch(gasUrl, {
        method: "POST",
        body: new URLSearchParams({
          action: "login",
          employeeId,
          password
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.needPasswordChange) {
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("change-password-section").classList.remove("hidden");
        } else if (data.success) {
          currentDepartment = data.department;
          currentFolderId = data.folderId;
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("signed-section").classList.remove("hidden");
          document.getElementById("department").textContent = data.department;
          loadPdfList();
        } else {
          alert(data.message);
        }
      });
    }

    function changePassword() {
      const newPassword = document.getElementById("newPassword").value.trim();
      fetch(gasUrl, {
        method: "POST",
        body: new URLSearchParams({
          action: "changePassword",
          employeeId: currentEmployeeId,
          oldPassword: currentPassword,
          newPassword
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("å¯†ç¢¼å·²è®Šæ›´ï¼Œè«‹é‡æ–°ç™»å…¥");
          window.location.reload();
        } else {
          alert(data.message);
        }
      });
    }

    function loadPdfList() {
      fetch(`${gasUrl}?action=getPdfList&folderId=${currentFolderId}`)
        .then(res => res.json())
        .then(data => {
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = "";
          data.files.forEach(file => {
            const li = document.createElement("li");
            li.textContent = `${file.name}ï¼ˆä¸Šå‚³æ™‚é–“ï¼š${file.date}ï¼‰`;
            fileList.appendChild(li);
          });
        });
    }

    // ç°½ååŠŸèƒ½
    const canvas = document.getElementById("signature");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    canvas.addEventListener("mousedown", e => {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener("mousemove", e => {
      if (drawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseleave", () => drawing = false);

    function clearPad() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function submitSignature() {
      const dataUrl = canvas.toDataURL("image/png");
      fetch(gasUrl, {
        method: "POST",
        body: new URLSearchParams({
          action: "generateSignedPdf",
          folderId: currentFolderId,
          dataUrl: dataUrl
        })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("result").textContent = data.success ? `âœ… PDF å·²ç”¢å‡ºï¼š${data.url}` : `âŒ ${data.message}`;
      });
    }
  </script>
</body>
</html>
