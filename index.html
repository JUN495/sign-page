<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“„ æ•¸è³‡ä¸­å¿ƒè³‡æ–™ç¢ºèªç³»çµ±</title>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; 
      padding: 0;
      font-family: 'Noto Sans TC', sans-serif;
      /* ç™½åº• + æ¼¸å±¤èƒŒæ™¯ + é»‘å­— */
      background: linear-gradient(135deg, #e0f2fe, #fef9c3);
      color: #000;
      min-height: 100vh;
    }
    .glass {
      backdrop-filter: blur(18px);
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      animation: fadeInUp 0.8s ease forwards;
      opacity: 0;
      transform: translateY(30px);
    }
    @keyframes fadeInUp {
      to {
        opacity: 1; 
        transform: translateY(0);
      }
    }
    #signature {
      touch-action: none;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: white;
      display: block;
      width: 100%;
      height: auto;
    }
    #fileList li {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.75);
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    #fileList li:hover {
      background: rgba(255, 255, 255, 0.95);
    }
    /* Toast */
    .toast {
      transition: transform 0.3s, opacity 0.3s;
      transform: translateX(100%);
      opacity: 0;
    }
    .toast-show {
      transform: translateX(0);
      opacity: 1;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center">

  <!-- Toast å®¹å™¨ -->
  <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <div class="glass w-full max-w-2xl p-8 rounded-2xl space-y-6">
    <!-- æ¨€é ­ -->
    <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-2 mb-4">
      <h1 class="text-3xl font-bold drop-shadow">
        ğŸ“„ æ•¸è³‡ä¸­å¿ƒè³‡æ–™ç¢ºèªç³»çµ±
      </h1>
    </div>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginView" class="space-y-4">
      <input
        id="empId"
        placeholder="å“¡å·¥ç·¨è™Ÿ"
        class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"
      />
      <input
        id="empPw"
        type="password"
        placeholder="å¯†ç¢¼"
        class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"
      />
      <button
        id="loginBtn"
        onclick="login()"
        class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-500 transition"
      >
        ç™»å…¥
      </button>
      <p id="loginMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- é¦–æ¬¡ç™»å…¥è®Šæ›´å¯†ç¢¼ -->
    <div id="changePwView" class="hidden space-y-4">
      <input
        id="oldPw"
        type="password"
        placeholder="èˆŠå¯†ç¢¼"
        class="w-full border border-gray-300 p-3 rounded-lg"
      />
      <input
        id="newPw"
        type="password"
        placeholder="æ–°å¯†ç¢¼"
        class="w-full border border-gray-300 p-3 rounded-lg"
      />
      <button
        onclick="changePassword()"
        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-500 transition"
      >
        è®Šæ›´å¯†ç¢¼
      </button>
      <p id="pwMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div id="mainView" class="hidden space-y-6">
      <!-- é ­éƒ¨ï¼šéƒ¨é–€ã€è·ç¨±ã€å§“å + ç™»å‡ºæŒ‰éˆ• -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
        <div class="flex flex-wrap items-center gap-4">
          <p class="font-semibold">
            éƒ¨é–€ï¼š
            <span id="dept" class="text-blue-700"></span>
          </p>
          <p class="font-semibold">
            è·ç¨±ï¼š
            <span id="title" class="text-pink-700"></span>
          </p>
          <p class="font-semibold">
            å§“åï¼š
            <span id="empName" class="text-green-700"></span>
          </p>
        </div>
        <button
          onclick="logout()"
          class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-400 transition"
        >
          ç™»å‡º
        </button>
      </div>

      <!-- PDF æ¸…å–® + æª”æ¡ˆé¡å‹åˆ‡æ› -->
      <div class="bg-white bg-opacity-90 p-4 rounded-lg shadow relative">
        <h2 class="text-lg font-bold mb-2">ğŸ“„ æª”æ¡ˆæ¸…å–®</h2>
        <!-- åˆ†é¡æŒ‰éˆ•ç¾¤ -->
        <div class="flex gap-2 mb-2">
          <button id="pdfBtn" onclick="renderFileList('pdf')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">PDF(0)</button>
          <button id="wordBtn" onclick="renderFileList('word')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Word(0)</button>
          <button id="othersBtn" onclick="renderFileList('others')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Others(0)</button>
          <button onclick="renderFileList('all')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">All</button>
        </div>
        <ul id="fileList" class="text-sm space-y-2">
          <li class="text-gray-500">è¼‰å…¥ä¸­...</li>
        </ul>
      </div>

      <!-- ç°½åå€ -->
      <div class="bg-white bg-opacity-90 p-4 rounded-lg shadow">
        <h2 class="text-lg font-bold mb-2">âœï¸ ç°½åå€</h2>
        <canvas id="signature"></canvas>
        <div class="flex justify-between mt-4">
          <button
            onclick="clearPad()"
            class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded transition"
          >
            æ¸…é™¤
          </button>
          <button
            id="submitBtn"
            onclick="submitSignature()"
            class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-500 transition"
          >
            é€å‡ºç°½å
          </button>
        </div>
        <p id="result" class="mt-4 text-center text-green-700 text-sm font-medium"></p>
      </div>
    </div>
  </div>

<script>
/*****************************************************
 * å…¨åŸŸè®Šæ•¸
*****************************************************/
let isSubmitting = false;
const api = "https://aged-lake-0db4.chiachun12171217.workers.dev"; // ä½ çš„ Worker URL
let folderId = "", currentFileList = [];

/*****************************************************
 * Toast
*****************************************************/
function showToast(msg, success=true){
  const container=document.getElementById('toastContainer');
  const toastDiv=document.createElement('div');
  toastDiv.className=`
    toast px-4 py-2 rounded shadow-lg mb-2
    ${success?'bg-green-500':'bg-red-500'} 
    text-white
  `;
  toastDiv.textContent=msg;
  container.appendChild(toastDiv);

  requestAnimationFrame(()=>{
    toastDiv.classList.add('toast-show');
  });
  setTimeout(()=>{
    toastDiv.classList.remove('toast-show');
    setTimeout(()=>{
      if(toastDiv.parentNode) toastDiv.parentNode.removeChild(toastDiv);
    },300);
  },2000);
}

/*****************************************************
 * ç™»å…¥
*****************************************************/
function login(){
  const idValue=empId.value.trim();
  const pwValue=empPw.value.trim();
  fetch(api+'/',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({
      action:'login',
      employeeId:idValue,
      password:pwValue
    })
  })
    .then(r=>r.json())
    .then(data=>{
      if(data.success){
        if(data.needPasswordChange){
          loginView.classList.add('hidden');
          changePwView.classList.remove('hidden');
        } else {
          // ä¸€èˆ¬ç™»å…¥
          loginView.classList.add('hidden');
          mainView.classList.remove('hidden');
          dept.textContent=data.department||'';
          title.textContent=data.title||'';
          empName.textContent=data.name||'';

          folderId=data.folderId;
          loadFileList();
          setTimeout(initSignatureCanvas,150);
          showToast('âœ… ç™»å…¥æˆåŠŸï¼');
        }
      } else {
        showToast(data.message,false);
        loginMsg.textContent=data.message;
      }
    })
    .catch(e=>{
      showToast('âŒ login API ç™¼ç”Ÿå•é¡Œ',false);
    });
}

/*****************************************************
 * é¦–æ¬¡ç™»å…¥â†’æ”¹å¯†ç¢¼
*****************************************************/
function changePassword(){
  const idValue=empId.value.trim();
  const oldPwValue=oldPw.value.trim();
  const newPwValue=newPw.value.trim();

  fetch(api+'/', {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({
      action:'changePassword',
      employeeId:idValue,
      oldPassword:oldPwValue,
      newPassword:newPwValue
    })
  })
    .then(r=>r.json())
    .then(data=>{
      if(data.success){
        alert('å¯†ç¢¼è®Šæ›´æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥');
        location.reload();
      } else {
        pwMsg.textContent=data.message;
        showToast(data.message,false);
      }
    })
    .catch(e=>{
      showToast('âŒ changePassword API ç™¼ç”Ÿå•é¡Œ',false);
    });
}

/*****************************************************
 * è¼‰å…¥æª”æ¡ˆæ¸…å–® + åˆ†é¡
*****************************************************/
function loadFileList(){
  fetch(`${api}/?action=getFileList&folderId=${folderId}`)
    .then(r=>r.json())
    .then(data=>{
      currentFileList=data.files||[];
      // çµ±è¨ˆpdf/word/others
      let pdfCount=0, wordCount=0, othersCount=0;
      currentFileList.forEach(f=>{
        if(f.extension==='pdf') pdfCount++;
        else if(['doc','docx','gdoc'].includes(f.extension)) wordCount++;
        else othersCount++;
      });
      pdfBtn.textContent=`PDF(${pdfCount})`;
      wordBtn.textContent=`Word(${wordCount})`;
      othersBtn.textContent=`Others(${othersCount})`;

      // é è¨­é¡¯ç¤ºå…¨éƒ¨
      renderFileList('all');
    })
    .catch(e=>{
      showToast('âŒ getFileList API ç™¼ç”Ÿå•é¡Œ',false);
    });
}

/*****************************************************
 * é¡¯ç¤ºæª”æ¡ˆæ¸…å–®ï¼špdf / word / others / all
*****************************************************/
function renderFileList(category){
  fileList.innerHTML='';
  let filtered = currentFileList.filter(f=>{
    if(category==='all') return true;
    if(category==='pdf') return (f.extension==='pdf');
    if(category==='word') return (['doc','docx','gdoc'].includes(f.extension));
    // others
    return !(['pdf','doc','docx','gdoc'].includes(f.extension));
  });

  if(filtered.length===0){
    let li=document.createElement('li');
    li.textContent='(ç„¡æª”æ¡ˆ)';
    li.className='text-gray-500';
    fileList.appendChild(li);
  } else {
    filtered.forEach(f=>{
      let li=document.createElement('li');
      li.textContent=`${f.name}ï¼ˆ${f.date}ï¼‰`;
      fileList.appendChild(li);
    });
  }
}

/*****************************************************
 * ç°½åç•«å¸ƒ
*****************************************************/
function initSignatureCanvas(){
  const c=signature;
  const ctx=c.getContext('2d');
  let drawing=false, lastX=0,lastY=0;

  function resizeCanvas(){
    const dpr=window.devicePixelRatio||1;
    const w=c.offsetWidth;
    let ratio=window.innerWidth<768?0.55:0.33;
    const h=Math.floor(w*ratio);

    c.width=w*dpr;
    c.height=h*dpr;
    c.style.height=h+'px';
    c.style.width=w+'px';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr,dpr);
  }
  resizeCanvas();
  window.addEventListener('resize',resizeCanvas);

  function getOffset(e){
    const rect=c.getBoundingClientRect();
    if(e.touches?.[0]) {
      return [ e.touches[0].clientX-rect.left, e.touches[0].clientY-rect.top];
    } else {
      return [ e.offsetX,e.offsetY ];
    }
  }
  function startDraw(e){
    drawing=true;
    let [x,y]=getOffset(e);
    ctx.beginPath();
    ctx.moveTo(x,y);
    [lastX,lastY]=[x,y];
  }
  function draw(e){
    if(!drawing)return;
    let [x,y]=getOffset(e);
    ctx.lineTo(x,y);
    ctx.strokeStyle='#000';
    ctx.lineWidth=2;
    ctx.lineCap='round';
    ctx.stroke();
    [lastX,lastY]=[x,y];
  }
  function endDraw(){
    drawing=false;
  }
  c.addEventListener('mousedown',startDraw);
  c.addEventListener('mousemove',draw);
  c.addEventListener('mouseup',endDraw);
  c.addEventListener('mouseleave',endDraw);

  c.addEventListener('touchstart',ev=>{
    ev.preventDefault();
    startDraw(ev);
  },{passive:false});
  c.addEventListener('touchmove',ev=>{
    ev.preventDefault();
    draw(ev);
  },{passive:false});
  c.addEventListener('touchend',endDraw);
}

/*****************************************************
 * ç°½åâ†’ç¸®åœ–å¾Œé€å‡º
*****************************************************/
function downscaleCanvas(originalCanvas, scale=0.3){
  if(window.innerWidth>768) scale=0.6; // æ¡Œæ©Ÿ
  const tmp=document.createElement('canvas');
  const cx=tmp.getContext('2d');
  tmp.width=originalCanvas.width*scale;
  tmp.height=originalCanvas.height*scale;
  cx.drawImage(originalCanvas,0,0,tmp.width,tmp.height);
  return tmp.toDataURL('image/png');
}

function clearPad(){
  let cx=signature.getContext('2d');
  cx.clearRect(0,0,signature.width,signature.height);
}

function submitSignature(){
  if(isSubmitting)return;
  toggleSubmitLoading(true);
  let dataUrl=downscaleCanvas(signature);

  fetch(api+'/',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({
      action:'generateSignedPdf',
      dataUrl,
      folderId,
      fileList:JSON.stringify(currentFileList)
    })
  })
    .then(r=>r.json())
    .then(data=>{
      toggleSubmitLoading(false);
      if(data.success){
        result.textContent='âœ… PDF ç”¢å‡ºæˆåŠŸï¼';
        showToast('âœ… PDF ç”¢å‡ºæˆåŠŸï¼');
        loadFileList();
      } else {
        result.textContent=data.message;
        showToast(data.message,false);
      }
    })
    .catch(e=>{
      toggleSubmitLoading(false);
      result.textContent='âŒ ç™¼ç”ŸéŒ¯èª¤';
      showToast('âŒ ç™¼é€éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦',false);
    });
}

function logout(){
  location.reload();
}

function toggleSubmitLoading(loading){
  let btn=document.getElementById('submitBtn');
  if(!btn)return;
  if(loading){
    isSubmitting=true;
    btn.disabled=true;
    btn.textContent='è™•ç†ä¸­...';
    btn.classList.remove('hover:bg-indigo-500');
    btn.classList.add('bg-gray-400');
  } else {
    isSubmitting=false;
    btn.disabled=false;
    btn.textContent='é€å‡ºç°½å';
    btn.classList.remove('bg-gray-400');
    btn.classList.add('bg-indigo-600','hover:bg-indigo-500');
  }
}
</script>
</body>
</html>
