<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ•¸ä½ç°½æ ¸ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #f0f4f8, #d9e2ec);
    }
    .fade-in {
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    canvas {
      touch-action: none;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="min-h-screen flex flex-col items-center justify-center px-4 py-8 fade-in">
    <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-2xl space-y-6">
      <h2 class="text-3xl font-bold text-center text-blue-700">ğŸ” å“¡å·¥ç™»å…¥ç³»çµ±</h2>

      <!-- ç™»å…¥å€ -->
      <div id="login-section">
        <input id="employeeId" class="w-full border px-3 py-2 rounded mt-2" placeholder="å“¡å·¥ç·¨è™Ÿ (å¦‚ CC0384)">
        <input id="password" class="w-full border px-3 py-2 rounded mt-2" type="password" placeholder="å¯†ç¢¼">
        <button onclick="login()" class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 w-full text-white py-2 rounded-lg font-bold mt-4 transition duration-200">ç™»å…¥</button>
      </div>

      <!-- é¦–æ¬¡ç™»å…¥è®Šæ›´å¯†ç¢¼å€ -->
      <div id="change-password-section" class="hidden">
        <p class="text-sm text-gray-600 mb-2">é¦–æ¬¡ç™»å…¥ï¼Œè«‹è®Šæ›´å¯†ç¢¼ï¼š</p>
        <input id="newPassword" class="w-full border px-3 py-2 rounded mt-2" type="password" placeholder="æ–°å¯†ç¢¼">
        <button onclick="changePassword()" class="bg-yellow-500 hover:bg-yellow-400 w-full text-white py-2 rounded font-bold mt-4">è®Šæ›´å¯†ç¢¼</button>
      </div>

      <!-- ç™»å…¥æˆåŠŸå€ -->
      <div id="signed-section" class="hidden space-y-4">
        <div>
          <p class="text-sm text-gray-800">âœ… ç™»å…¥æˆåŠŸï¼éƒ¨é–€ï¼š<span id="department"></span></p>
        </div>
        <div>
          <h3 class="text-sm font-bold text-gray-600 mb-1">ğŸ“„ PDF æ¸…å–®</h3>
          <table class="w-full text-left text-sm text-gray-700 border border-gray-300">
            <thead class="bg-gray-200">
              <tr><th class="px-4 py-2 border">æª”å</th><th class="px-4 py-2 border">ä¸Šå‚³æ—¥æœŸ</th></tr>
            </thead>
            <tbody id="fileList" class="divide-y"></tbody>
          </table>
        </div>
        <div>
          <h3 class="text-sm font-bold text-gray-600 mb-1">âœï¸ ç°½åå€</h3>
          <canvas id="signature" class="border bg-white rounded shadow w-full sm:w-auto" width="500" height="150"></canvas>
          <div class="flex flex-col sm:flex-row gap-4 mt-2">
            <button onclick="clearPad()" class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded w-full sm:w-auto">æ¸…é™¤</button>
            <button onclick="submitSignature()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded w-full sm:w-auto">é€å‡ºç°½å</button>
          </div>
        </div>
        <div id="result" class="text-green-600 font-bold text-center text-sm"></div>
        <div id="pdfPreview" class="mt-4 hidden">
          <h3 class="text-sm font-bold text-gray-600 mb-1 text-center">ğŸ“„ é è¦½ç”¢å‡º PDF</h3>
          <iframe id="pdfFrame" class="w-full h-[600px] border rounded shadow"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    const gasUrl = "https://aged-lake-0db4.chiachun12171217.workers.dev";
    let currentEmployeeId = "";
    let currentPassword = "";
    let currentDepartment = "";
    let currentFolderId = "";
    let currentPdfList = [];

    function login() {
      const employeeId = document.getElementById("employeeId").value.trim();
      const password = document.getElementById("password").value.trim();
      currentEmployeeId = employeeId;
      currentPassword = password;

      fetch(gasUrl, {
        method: "POST",
        body: new URLSearchParams({
          action: "login",
          employeeId,
          password
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.needPasswordChange) {
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("change-password-section").classList.remove("hidden");
        } else if (data.success) {
          currentDepartment = data.department;
          currentFolderId = data.folderId;
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("signed-section").classList.remove("hidden");
          document.getElementById("department").textContent = data.department;
          loadPdfList();
        } else {
          alert(data.message);
        }
      });
    }

    function changePassword() {
      const newPassword = document.getElementById("newPassword").value.trim();
      fetch(gasUrl, {
        method: "POST",
        body: new URLSearchParams({
          action: "changePassword",
          employeeId: currentEmployeeId,
          oldPassword: currentPassword,
          newPassword
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("å¯†ç¢¼å·²è®Šæ›´ï¼Œè«‹é‡æ–°ç™»å…¥");
          window.location.reload();
        } else {
          alert(data.message);
        }
      });
    }

    function loadPdfList() {
      fetch(`${gasUrl}?action=getPdfList&folderId=${currentFolderId}`)
        .then(res => res.json())
        .then(data => {
          currentPdfList = data.files || [];
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = "";
          currentPdfList.forEach(file => {
            const tr = document.createElement("tr");
            const td1 = document.createElement("td");
            const td2 = document.createElement("td");
            td1.className = "px-4 py-2 border";
            td2.className = "px-4 py-2 border";
            td1.textContent = file.name;
            td2.textContent = file.date.split(' ')[0];
            tr.appendChild(td1);
            tr.appendChild(td2);
            fileList.appendChild(tr);
          });
        });
    }

    const canvas = document.getElementById("signature");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    canvas.addEventListener("mousedown", e => {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener("mousemove", e => {
      if (drawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseleave", () => drawing = false);

    function clearPad() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function submitSignature() {
      const dataUrl = canvas.toDataURL("image/png");
      fetch(gasUrl, {
        method: "POST",
        body: new URLSearchParams({
          action: "generateSignedPdf",
          folderId: currentFolderId,
          dataUrl: dataUrl,
          fileList: JSON.stringify(currentPdfList)
        })
      })
      .then(res => res.json())
      .then(data => {
        const result = document.getElementById("result");
        if (data.success && data.url) {
          result.textContent = "âœ… PDF å·²æˆåŠŸç”¢å‡ºï¼";
          const frame = document.getElementById("pdfFrame");
          frame.src = data.url;
          document.getElementById("pdfPreview").classList.remove("hidden");
        } else {
          result.textContent = `âŒ ${data.message}`;
        }
      });
    }
  </script>
</body>
</html>
