<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📄 數資中心資料確認系統</title>

  <!-- Tailwind: 開啟 darkMode: class -->
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #e0f2fe, #fef9c3);
      min-height: 100vh;
      /* 預設不加 class="dark" => 預設亮色 */
    }
    .dark body {
      background: #1e293b; /* Slate-800 */
    }
    .glass {
      backdrop-filter: blur(18px);
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      animation: fadeInUp 0.8s ease forwards;
      opacity: 0;
      transform: translateY(30px);
    }
    @keyframes fadeInUp {
      to {
        opacity: 1; transform: translateY(0);
      }
    }
    #signature {
      touch-action: none;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: white;
      display: block;
      width: 100%;
      height: auto;
    }
    #fileList li {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.75);
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    #fileList li:hover {
      background: rgba(255, 255, 255, 0.95);
    }
    .toast {
      transition: transform 0.3s, opacity 0.3s;
      transform: translateX(100%);
      opacity: 0;
    }
    .toast-show {
      transform: translateX(0);
      opacity: 1;
    }
  </style>
</head>

<body class="dark:bg-slate-800 dark:text-gray-100 flex items-center justify-center p-6">

  <!-- Toast 容器 -->
  <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <div class="glass w-full max-w-2xl p-8 rounded-2xl space-y-6 dark:bg-white/10">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold drop-shadow">
        📄 數資中心資料確認系統
      </h1>
      <!-- 深色模式切換按鈕 (預設亮色 => 按一下進入深色 => 按鈕文字改成「切換亮色」) -->
      <button id="toggleDarkBtn"
        onclick="toggleDarkMode()"
        class="bg-gray-300 dark:bg-slate-600 text-sm px-3 py-1 rounded"
      >
        切換深色
      </button>
    </div>

    <!-- 登入畫面 -->
    <div id="loginView" class="space-y-4">
      <input id="empId" placeholder="員工編號"
        class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:text-black"/>
      <input id="empPw" type="password" placeholder="密碼"
        class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:text-black"/>
      <button id="loginBtn"
        onclick="login()"
        class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-500 transition"
      >
        登入
      </button>
      <p id="loginMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- 首次登入變更密碼 -->
    <div id="changePwView" class="hidden space-y-4">
      <input id="oldPw" type="password" placeholder="舊密碼"
        class="w-full border border-gray-300 p-3 rounded-lg dark:text-black"/>
      <input id="newPw" type="password" placeholder="新密碼"
        class="w-full border border-gray-300 p-3 rounded-lg dark:text-black"/>
      <button onclick="changePassword()"
        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-500 transition">
        變更密碼
      </button>
      <p id="pwMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- 主畫面 -->
    <div id="mainView" class="hidden space-y-6">
      <!-- 頭部：部門/職稱/姓名 + 登出按鈕 -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
        <div class="flex flex-wrap items-center gap-4">
          <p class="font-semibold">
            部門：<span id="dept" class="text-blue-600 dark:text-blue-400"></span>
          </p>
          <p class="font-semibold">
            職稱：<span id="title" class="text-pink-600 dark:text-pink-400"></span>
          </p>
          <p class="font-semibold">
            姓名：<span id="empName" class="text-green-600 dark:text-green-400"></span>
          </p>
        </div>
        <button onclick="logout()"
          class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-400 transition">
          登出
        </button>
      </div>

      <!-- PDF 清單 -->
      <div class="bg-white bg-opacity-90 p-4 rounded-lg shadow dark:bg-slate-700 dark:bg-opacity-40">
        <h2 class="text-lg font-bold mb-2">📄 PDF 清單</h2>
        <ul id="fileList" class="text-sm space-y-2">
          <li class="text-gray-500 dark:text-gray-200">載入中...</li>
        </ul>
      </div>

      <!-- 簽名區 + 預覽 PDF -->
      <div class="bg-white bg-opacity-90 p-4 rounded-lg shadow dark:bg-slate-700 dark:bg-opacity-40 relative">
        <h2 class="text-lg font-bold mb-2">✍️ 簽名區</h2>
        <canvas id="signature"></canvas>
        <div class="flex justify-between mt-4">
          <button
            onclick="clearPad()"
            class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded transition dark:bg-slate-500 dark:hover:bg-slate-400"
          >
            清除
          </button>
          <button
            id="submitBtn"
            onclick="submitSignature()"
            class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-500 transition"
          >
            送出簽名
          </button>
        </div>
        <p id="result" class="mt-4 text-center text-green-700 dark:text-green-300 text-sm font-medium"></p>

        <!-- PDF 預覽 區塊：隱藏，等成功產出後才顯示 -->
        <div id="pdfPreviewWrapper" class="mt-4 hidden">
          <h3 class="text-base font-semibold mb-2">預覽簽核 PDF</h3>
          <iframe id="pdfPreviewFrame"
            class="w-full h-96 border border-gray-300"
            src=""
          ></iframe>
        </div>
      </div>
    </div>
  </div>

<script>
const api = "https://aged-lake-0db4.chiachun12171217.workers.dev"; // 後端 Worker
let userToken = "",
  folderId = "",
  currentFileList = [],
  lastPdfUrl = "",
  isDark = false,
  isSubmitting = false;

/*****************************************************
 * 1. 深色模式切換
*****************************************************/
function toggleDarkMode() {
  const htmlEl = document.documentElement;
  isDark = !isDark;
  if (isDark) {
    // 切成 dark
    htmlEl.classList.add('dark');
    toggleDarkBtn.textContent = "切換亮色";
  } else {
    // 切成 light
    htmlEl.classList.remove('dark');
    toggleDarkBtn.textContent = "切換深色";
  }
}

/*****************************************************
 * 2. Toast 提示
*****************************************************/
function showToast(msg, isSuccess = true) {
  const container = document.getElementById('toastContainer');
  const toastDiv = document.createElement('div');
  toastDiv.className = `
    toast px-4 py-2 rounded shadow-lg mb-2
    ${isSuccess ? 'bg-green-500' : 'bg-red-500'} 
    text-white
  `;
  toastDiv.textContent = msg;
  container.appendChild(toastDiv);

  // 進場
  requestAnimationFrame(() => {
    toastDiv.classList.add('toast-show');
  });

  // 2 秒後自動關閉
  setTimeout(() => {
    toastDiv.classList.remove('toast-show');
    setTimeout(() => {
      if (toastDiv.parentNode) {
        toastDiv.parentNode.removeChild(toastDiv);
      }
    }, 300);
  }, 2000);
}

/*****************************************************
 * 3. 登入
*****************************************************/
function login() {
  const idValue = empId.value.trim();
  const pwValue = empPw.value.trim();

  fetch(api + "/", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      action: "login",
      employeeId: idValue,
      password: pwValue
    })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        if (data.needPasswordChange) {
          loginView.classList.add("hidden");
          changePwView.classList.remove("hidden");
        } else {
          loginView.classList.add("hidden");
          mainView.classList.remove("hidden");

          dept.textContent = data.department || "";
          title.textContent = data.title || "";
          empName.textContent = data.name || "";

          folderId = data.folderId;
          loadFileList();
          setTimeout(initSignatureCanvas, 150);

          showToast("✅ 登入成功！");
        }
      } else {
        showToast(data.message, false);
        loginMsg.textContent = data.message;
      }
    })
    .catch(() => {
      showToast("❌ login API 發生問題", false);
    });
}

/*****************************************************
 * 4. 首次登入 → 改密碼
*****************************************************/
function changePassword() {
  const idValue = empId.value.trim();
  const oldPwValue = oldPw.value.trim();
  const newPwValue = newPw.value.trim();

  fetch(api + "/", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      action: "changePassword",
      employeeId: idValue,
      oldPassword: oldPwValue,
      newPassword: newPwValue
    })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("密碼變更成功，請重新登入");
        location.reload();
      } else {
        pwMsg.textContent = data.message;
        showToast(data.message, false);
      }
    })
    .catch(() => {
      showToast("❌ changePassword API 發生問題", false);
    });
}

/*****************************************************
 * 5. 載入 PDF 清單
*****************************************************/
function loadFileList() {
  fetch(`${api}/?action=getPdfList&folderId=${folderId}`)
    .then(res => res.json())
    .then(data => {
      currentFileList = data.files || [];
      fileList.innerHTML = "";
      if (currentFileList.length === 0) {
        const li = document.createElement("li");
        li.textContent = "尚無 PDF 檔案";
        li.className = "text-gray-500";
        fileList.appendChild(li);
      } else {
        currentFileList.forEach(file => {
          const li = document.createElement("li");
          li.textContent = `${file.name}（${file.date}）`;
          fileList.appendChild(li);
        });
      }
    })
    .catch(() => {
      showToast("❌ getPdfList API 發生問題", false);
    });
}

/*****************************************************
 * 6. 簽名畫布
*****************************************************/
function initSignatureCanvas() {
  const canvas = signature;
  const ctx = canvas.getContext("2d");
  let drawing = false;
  let lastX = 0, lastY = 0;

  function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const width = canvas.offsetWidth;
    // 手機 => 0.55, 電腦 => 0.33
    let ratio = window.innerWidth < 768 ? 0.55 : 0.33;
    const height = Math.floor(width * ratio);

    canvas.width = width * dpr;
    canvas.height = height * dpr;
    canvas.style.height = height + "px";
    canvas.style.width = width + "px";
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);
  }

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  function getOffset(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches?.[0]) {
      return [ e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top ];
    } else {
      return [ e.offsetX, e.offsetY ];
    }
  }
  function startDraw(e) {
    drawing = true;
    const [x, y] = getOffset(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
    [lastX, lastY] = [x, y];
  }
  function draw(e) {
    if (!drawing) return;
    const [x, y] = getOffset(e);
    ctx.lineTo(x, y);
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.stroke();
    [lastX, lastY] = [x, y];
  }
  function endDraw() {
    drawing = false;
  }
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    startDraw(e);
  }, { passive: false });
  canvas.addEventListener("touchmove", e => {
    e.preventDefault();
    draw(e);
  }, { passive: false });
  canvas.addEventListener("touchend", endDraw);
}

/*****************************************************
 * 7. 簽名 → 縮圖後送出
*****************************************************/
function downscaleCanvas(originalCanvas, scale = 0.3) {
  if (window.innerWidth > 768) {
    scale = 0.6; // 桌機
  }
  const tmpCanvas = document.createElement("canvas");
  const ctx2 = tmpCanvas.getContext("2d");
  tmpCanvas.width = originalCanvas.width * scale;
  tmpCanvas.height = originalCanvas.height * scale;
  ctx2.drawImage(originalCanvas, 0, 0, tmpCanvas.width, tmpCanvas.height);
  return tmpCanvas.toDataURL("image/png");
}

function clearPad() {
  const c = signature;
  const context = c.getContext("2d");
  context.clearRect(0, 0, c.width, c.height);
}

function submitSignature() {
  if (isSubmitting) return;
  toggleSubmitLoading(true);

  const c = signature;
  const dataUrl = downscaleCanvas(c);

  fetch(`${api}/`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      action: "generateSignedPdf",
      dataUrl,
      folderId,
      fileList: JSON.stringify(currentFileList)
    })
  })
    .then(res => res.json())
    .then(data => {
      toggleSubmitLoading(false);
      if (data.success) {
        result.textContent = "✅ PDF 產出成功！";
        showToast("✅ PDF 產出成功！");

        loadFileList();

        // TODO: 後端 setSharing(ANYONE_WITH_LINK, VIEW) => data.url
        // 直接內嵌 pdf
        pdfPreviewFrame.src = data.url; 
        pdfPreviewWrapper.classList.remove('hidden');
      } else {
        result.textContent = data.message;
        showToast(data.message, false);
      }
    })
    .catch(() => {
      toggleSubmitLoading(false);
      result.textContent = "❌ 發生錯誤";
      showToast("❌ 發送錯誤，請稍後再試", false);
    });
}

/*****************************************************
 * 8. 預覽 PDF
*****************************************************/
function previewPdf() {
  // 只需要這個如果要另開視窗
  // window.open(pdfPreviewFrame.src, '_blank')
}

/*****************************************************
 * 9. 登出
*****************************************************/
function logout() {
  location.reload();
}

/*****************************************************
 * 10. 送出簽名時顯示 LOADING
*****************************************************/
function toggleSubmitLoading(loading) {
  const btn = document.getElementById("submitBtn");
  if (!btn) return;

  if (loading) {
    isSubmitting = true;
    btn.disabled = true;
    btn.textContent = "處理中...";
    btn.classList.remove("hover:bg-indigo-500");
    btn.classList.add("bg-gray-400");
  } else {
    isSubmitting = false;
    btn.disabled = false;
    btn.textContent = "送出簽名";
    btn.classList.remove("bg-gray-400");
    btn.classList.add("bg-indigo-600", "hover:bg-indigo-500");
  }
}
</script>

</body>
</html>
