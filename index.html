<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“„ æ•¸è³‡ä¸­å¿ƒè³‡æ–™ç¢ºèªç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">

  <style>
    html, body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #e0f2fe, #fef9c3);
      min-height: 100vh;
    }
    .glass {
      backdrop-filter: blur(18px);
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      animation: fadeInUp 0.8s ease forwards;
      opacity: 0;
      transform: translateY(30px);
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    #signature {
      touch-action: none;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: white;
      display: block;
      width: 100%;
      height: auto;
    }
    #fileList li {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.75);
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    #fileList li:hover {
      background: rgba(255, 255, 255, 0.95);
    }
    /* Toast å‹•ç•« */
    .toast-enter {
      opacity: 0;
      transform: translateX(100%);
    }
    .toast-enter-active {
      transition: opacity 0.3s, transform 0.3s;
      opacity: 1;
      transform: translateX(0);
    }
    .toast-leave {
      opacity: 1;
      transform: translateX(0);
    }
    .toast-leave-active {
      transition: opacity 0.3s, transform 0.3s;
      opacity: 0;
      transform: translateX(100%);
    }
  </style>
</head>

<body class="flex items-center justify-center p-6">

  <div class="glass w-full max-w-2xl p-8 rounded-2xl space-y-6 relative">
    <h1 class="text-3xl font-bold text-center text-indigo-700 drop-shadow">
      ğŸ“„ æ•¸è³‡ä¸­å¿ƒè³‡æ–™ç¢ºèªç³»çµ±
    </h1>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginView" class="space-y-4">
      <input id="empId" placeholder="å“¡å·¥ç·¨è™Ÿ"
        class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"/>
      <input id="empPw" type="password" placeholder="å¯†ç¢¼"
        class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"/>
      <button onclick="login()"
        class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-500 transition">
        ç™»å…¥
      </button>
      <p id="loginMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- é¦–æ¬¡ç™»å…¥è®Šæ›´å¯†ç¢¼ -->
    <div id="changePwView" class="hidden space-y-4">
      <input id="oldPw" type="password" placeholder="èˆŠå¯†ç¢¼"
        class="w-full border border-gray-300 p-3 rounded-lg"/>
      <input id="newPw" type="password" placeholder="æ–°å¯†ç¢¼"
        class="w-full border border-gray-300 p-3 rounded-lg"/>
      <button onclick="changePassword()"
        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-500 transition">
        è®Šæ›´å¯†ç¢¼
      </button>
      <p id="pwMsg" class="text-center text-red-600 text-sm"></p>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div id="mainView" class="hidden space-y-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
        <div class="flex flex-wrap items-center gap-4">
          <p class="text-gray-800 font-semibold">
            éƒ¨é–€ï¼š<span id="dept" class="text-blue-600"></span>
          </p>
          <p class="text-gray-800 font-semibold">
            è·ç¨±ï¼š<span id="title" class="text-pink-600"></span>
          </p>
          <p class="text-gray-800 font-semibold">
            å§“åï¼š<span id="empName" class="text-green-600"></span>
          </p>
        </div>
        <button onclick="logout()"
          class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-400 transition">
          ç™»å‡º
        </button>
      </div>

      <!-- PDF æ¸…å–® -->
      <div class="bg-white bg-opacity-90 p-4 rounded-lg shadow">
        <h2 class="text-lg font-bold mb-2">ğŸ“„ PDF æ¸…å–®</h2>
        <ul id="fileList" class="text-sm text-gray-800 space-y-2">
          <li class="text-gray-500">è¼‰å…¥ä¸­...</li>
        </ul>
      </div>

      <!-- ç°½åå€ -->
      <div class="bg-white bg-opacity-90 p-4 rounded-lg shadow relative">
        <h2 class="text-lg font-bold mb-2">âœï¸ ç°½åå€</h2>
        <canvas id="signature"></canvas>
        <div class="flex justify-between mt-4">
          <button onclick="clearPad()"
            class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded transition">
            æ¸…é™¤
          </button>
          <button id="submitBtn"
            onclick="submitSignature()"
            class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-500 transition">
            é€å‡ºç°½å
          </button>
        </div>
        <p id="result" class="mt-4 text-center text-green-700 text-sm font-medium"></p>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ï¼šæç¤ºç”¨ Modal (åªåœ¨é¦–æ¬¡ç™»å…¥æ”¹å®Œå¯†ç¢¼ or ç¬¬ä¸€æ¬¡é€²å…¥ mainView æ™‚é¡¯ç¤º) -->
  <div id="guideModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full space-y-4">
      <h2 class="text-xl font-bold text-gray-800">æ“ä½œå¼•å°</h2>
      <p class="text-sm text-gray-600">
        è«‹åœ¨ä¸‹æ–¹ã€Œç°½åå€ã€ç°½ä¸‹æ‚¨çš„å§“åï¼Œä¸¦ç¢ºèªä¸Šæ–¹ PDF æ¸…å–®å…§å®¹å¾Œå†é€å‡ºã€‚è‹¥æœ‰ç–‘å•è«‹æ´½ç³»çµ±ç®¡ç†å“¡ã€‚
      </p>
      <button onclick="closeGuide()"
        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-500">
        æˆ‘çŸ¥é“äº†
      </button>
    </div>
  </div>

  <!-- Toast æç¤ºå€ -->
  <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50"></div>

<script>
  const api = "https://aged-lake-0db4.chiachun12171217.workers.dev";
  let userToken = "",
      folderId = "",
      currentFileList = [];

  /***************************************
   * 1. Show / Hide Guide Modal
   ***************************************/
  function showGuide() {
    document.getElementById("guideModal").classList.remove("hidden");
    document.getElementById("guideModal").classList.add("flex");
  }
  function closeGuide() {
    document.getElementById("guideModal").classList.add("hidden");
    document.getElementById("guideModal").classList.remove("flex");
  }

  /***************************************
   * 2. Toast åŠŸèƒ½
   ***************************************/
  let toastCount = 0;
  function showToast(message, success = true) {
    toastCount++;
    const toastId = `toast-${toastCount}`;
    const toastContainer = document.getElementById("toastContainer");

    // å»ºç«‹ toast å…ƒç´ 
    const toastDiv = document.createElement("div");
    toastDiv.id = toastId;
    toastDiv.className = `
      px-4 py-2 rounded shadow-lg mb-2
      ${success ? "bg-green-600 text-white" : "bg-red-600 text-white"}
      toast-enter
    `;
    toastDiv.textContent = message;
    toastContainer.appendChild(toastDiv);

    // é€²å ´å‹•ç•«
    requestAnimationFrame(() => {
      toastDiv.classList.add("toast-enter-active");
    });

    // 2 ç§’å¾Œé—œé–‰
    setTimeout(() => {
      // é›¢å ´
      toastDiv.classList.remove("toast-enter-active");
      toastDiv.classList.add("toast-leave");

      requestAnimationFrame(() => {
        toastDiv.classList.add("toast-leave-active");
      });

      // 0.3s å¾Œç§»é™¤ç¯€é»
      setTimeout(() => {
        if (toastDiv && toastDiv.parentNode) {
          toastDiv.parentNode.removeChild(toastDiv);
        }
      }, 300);
    }, 2000);
  }

  /***************************************
   * 3. é€å‡ºç°½åæ™‚é¡¯ç¤ºã€ŒLoading / Spinnerã€
   ***************************************/
  let isSubmitting = false;
  function toggleSubmitLoading(loading) {
    const btn = document.getElementById("submitBtn");
    if (loading) {
      isSubmitting = true;
      btn.disabled = true;
      btn.textContent = "è™•ç†ä¸­...";
      btn.classList.remove("hover:bg-indigo-500");
      btn.classList.add("bg-gray-400");
    } else {
      isSubmitting = false;
      btn.disabled = false;
      btn.textContent = "é€å‡ºç°½å";
      btn.classList.remove("bg-gray-400");
      btn.classList.add("bg-indigo-600", "hover:bg-indigo-500");
    }
  }

  /***************************************
   * ç°½åç•«å¸ƒåˆå§‹åŒ–
   ***************************************/
  function initSignatureCanvas() {
    const canvas = document.getElementById("signature");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let lastX = 0, lastY = 0;

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.offsetWidth;
      // è‹¥è¢å¹• < 768ï¼Œè¦–ç‚ºæ‰‹æ©Ÿ => é«˜åº¦ 0.55
      // é›»è…¦ => é«˜åº¦ 0.33
      let ratio = window.innerWidth < 768 ? 0.55 : 0.33;
      const height = Math.floor(width * ratio);

      canvas.width = width * dpr;
      canvas.height = height * dpr;
      canvas.style.height = height + "px";
      canvas.style.width = width + "px";

      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(dpr, dpr);
    }

    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    function getOffset(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches?.[0]) {
        return [ e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top ];
      } else {
        return [ e.offsetX, e.offsetY ];
      }
    }
    function startDraw(e) {
      drawing = true;
      const [x, y] = getOffset(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
      [lastX, lastY] = [x, y];
    }
    function draw(e) {
      if (!drawing) return;
      const [x, y] = getOffset(e);
      ctx.lineTo(x, y);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.stroke();
      [lastX, lastY] = [x, y];
    }
    function endDraw() {
      drawing = false;
    }
    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", endDraw);
    canvas.addEventListener("mouseleave", endDraw);

    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      startDraw(e);
    }, { passive: false });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      draw(e);
    }, { passive: false });

    canvas.addEventListener("touchend", endDraw);
  }

  /***************************************
   * downscaleCanvas â†’ ç¸®å°åœ–ç‰‡å†é€å‡º
   ***************************************/
  function downscaleCanvas(originalCanvas, scale = 0.3) {
    // å¦‚æœæ˜¯æ¡Œæ©Ÿ => 0.6 (ä½ å¯ä»¥å†èª¿æ•´)
    if (window.innerWidth > 768) {
      scale = 0.6;
    }
    const tmpCanvas = document.createElement("canvas");
    const ctx2 = tmpCanvas.getContext("2d");
    tmpCanvas.width = originalCanvas.width * scale;
    tmpCanvas.height = originalCanvas.height * scale;
    ctx2.drawImage(
      originalCanvas,
      0,
      0,
      tmpCanvas.width,
      tmpCanvas.height
    );
    return tmpCanvas.toDataURL("image/png");
  }

  /***************************************
   * ç™»å…¥ / æ”¹å¯†ç¢¼ / æ¸…å–® / é€å‡ºé‚è¼¯
   ***************************************/
  function login() {
    const id = empId.value.trim();
    const pw = empPw.value.trim();
    fetch(api + "/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "login",
        employeeId: id,
        password: pw,
      }),
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (data.needPasswordChange) {
            loginView.classList.add("hidden");
            changePwView.classList.remove("hidden");
          } else {
            loginView.classList.add("hidden");
            mainView.classList.remove("hidden");

            dept.textContent = data.department || "";
            title.textContent = data.title || "";
            empName.textContent = data.name || "";

            userToken = data.token;
            folderId = data.folderId;
            loadFileList();

            // åˆå§‹åŒ–ç°½å
            setTimeout(initSignatureCanvas, 150);

            // é¡¯ç¤ºé¦–æ¬¡ç™»å…¥å¼•å° (å¦‚æœä½ æƒ³åªåœ¨ç¬¬ä¸€æ¬¡ç™»å…¥é¡¯ç¤ºï¼Œä¹Ÿå¯ç”¨å…¶ä»–æ¢ä»¶)
            showGuide();
          }
        } else {
          showToast(data.message, false); // ç”¨å¤±æ•— Toast
          loginMsg.textContent = data.message;
        }
      })
      .catch(() => {
        showToast("âŒ login API ç™¼ç”Ÿå•é¡Œ", false);
      });
  }

  function changePassword() {
    const id = empId.value.trim();
    const oldPw = oldPw.value.trim();
    const newPw = newPw.value.trim();
    fetch(`${api}/`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "changePassword",
        employeeId: id,
        oldPassword: oldPw,
        newPassword: newPw,
      }),
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("å¯†ç¢¼è®Šæ›´æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥");
          location.reload();
        } else {
          pwMsg.textContent = data.message;
          showToast(data.message, false);
        }
      });
  }

  function loadFileList() {
    fetch(`${api}/?action=getPdfList&folderId=${folderId}`)
      .then(res => res.json())
      .then(data => {
        currentFileList = data.files;
        const list = fileList;
        list.innerHTML = "";
        data.files.forEach(file => {
          const li = document.createElement("li");
          li.textContent = `${file.name}ï¼ˆ${file.date}ï¼‰`;
          list.appendChild(li);
        });
      });
  }

  function clearPad() {
    const c = signature;
    const context = c.getContext("2d");
    context.clearRect(0, 0, c.width, c.height);
  }

  function submitSignature() {
    // é€å‡ºç°½åæ™‚é¡¯ç¤º LOADING
    if (isSubmitting) return; // é¿å…é‡è¤‡é»
    toggleSubmitLoading(true);

    const c = signature;
    // æ‰‹æ©Ÿ 0.3 / é›»è…¦ 0.6
    const dataUrl = downscaleCanvas(c);

    fetch(`${api}/`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "generateSignedPdf",
        dataUrl,
        folderId,
        fileList: JSON.stringify(currentFileList),
      }),
    })
      .then(res => res.json())
      .then(data => {
        toggleSubmitLoading(false);
        if (data.success) {
          showToast("âœ… PDF ç”¢å‡ºæˆåŠŸï¼");
          result.textContent = "âœ… PDF ç”¢å‡ºæˆåŠŸï¼";
          loadFileList();
        } else {
          showToast(data.message, false);
          result.textContent = data.message;
        }
      })
      .catch(() => {
        toggleSubmitLoading(false);
        showToast("âŒ ç™¼é€éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦", false);
      });
  }

  // ç™»å‡ºåŠŸèƒ½
  function logout() {
    location.reload();
  }

  // è‹¥æƒ³é è¦½ PDFï¼Œå¯ä»¥é€™æ¨£åšï¼Œä½†æª”æ¡ˆéœ€åˆ†äº«è¨­å®š
  function previewPdf() {
    // window.open(data.url, '_blank');
  }

  /***************************************
   * é€å‡ºç°½åæ™‚é¡¯ç¤ºã€ŒLoading / Spinnerã€
   ***************************************/
  let isSubmitting = false;
  function toggleSubmitLoading(loading) {
    const btn = document.getElementById("submitBtn") || document.getElementById("submitSignature") || document.querySelector("[onclick='submitSignature()']");
    if (!btn) return;

    if (loading) {
      isSubmitting = true;
      btn.disabled = true;
      btn.textContent = "è™•ç†ä¸­...";
      btn.classList.remove("hover:bg-indigo-500");
      btn.classList.add("bg-gray-400");
    } else {
      isSubmitting = false;
      btn.disabled = false;
      btn.textContent = "é€å‡ºç°½å";
      btn.classList.remove("bg-gray-400");
      btn.classList.add("bg-indigo-600", "hover:bg-indigo-500");
    }
  }
</script>
</body>
</html>
