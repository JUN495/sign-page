const SHEET_ID = '16Ba5xYM78fpp5c5WvF84GJD86x6DPEBVkUs_feb1ToU';
const SHEET_NAME = '工作表1'; // 對應你的實際工作表
const TEMPLATE_DOC_ID = '1YlHyYQIiyJr2hnrKCCISZsT5Ga_Fg0IT5SlzIvNOJpk';
const OUTPUT_FOLDER_ID = '1rHEpM0rx13aTx81xajmh8gV2yDMbi6kz';

function doPost(e) {
  const action = e.parameter.action;

  if (action === 'login') return handleLogin(e.parameter);
  if (action === 'changePassword') return handleChangePassword(e.parameter);
  if (action === 'generateSignedPdf') return generateSignedPdf(e.parameter);

  return ContentService.createTextOutput(
    JSON.stringify({ success: false, message: '未知的 action' })
  ).setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  const action = e.parameter.action;

  // ★ 新增：getFileList，回傳資料夾內「所有檔案」，並附上 extension
  if (action === 'getFileList') {
    const folderId = e.parameter.folderId;
    try {
      const folder = DriveApp.getFolderById(folderId);
      const files = folder.getFiles();
      const result = [];

      while (files.hasNext()) {
        const file = files.next();
        const name = file.getName();
        const mime = file.getMimeType();

        // 以副檔名簡易判斷
        let ext = name.split('.').pop().toLowerCase();

        // 若為 Google Docs/Sheets/Slides 可再細分
        if (mime === MimeType.GOOGLE_DOCS) {
          ext = 'gdoc';
        } else if (mime === MimeType.GOOGLE_SHEETS) {
          ext = 'gsheet';
        } else if (mime === MimeType.GOOGLE_SLIDES) {
          ext = 'gslides';
        }
        // 你也可自行加更多判斷

        result.push({
          name,
          date: Utilities.formatDate(
            file.getDateCreated(),
            Session.getScriptTimeZone(),
            'yyyy/MM/dd HH:mm'
          ),
          extension: ext
        });
      }

      return ContentService.createTextOutput(
        JSON.stringify({ success: true, files: result })
      ).setMimeType(ContentService.MimeType.JSON);
    } catch (err) {
      return ContentService.createTextOutput(
        JSON.stringify({ success: false, message: err.message })
      ).setMimeType(ContentService.MimeType.JSON);
    }
  }

  // ★ 若仍需保留舊的 getPdfList，可留著；否則可刪除
  if (action === 'getPdfList') {
    const folderId = e.parameter.folderId;
    try {
      const folder = DriveApp.getFolderById(folderId);
      const files = folder.getFiles();
      const result = [];
      while (files.hasNext()) {
        const file = files.next();
        if (file.getMimeType() === MimeType.PDF) {
          result.push({
            name: file.getName(),
            date: Utilities.formatDate(
              file.getDateCreated(),
              Session.getScriptTimeZone(),
              'yyyy/MM/dd HH:mm'
            )
          });
        }
      }
      return ContentService.createTextOutput(
        JSON.stringify({ success: true, files: result })
      ).setMimeType(ContentService.MimeType.JSON);
    } catch (err) {
      return ContentService.createTextOutput(
        JSON.stringify({ success: false, message: err.message })
      ).setMimeType(ContentService.MimeType.JSON);
    }
  }

  return ContentService.createTextOutput(
    JSON.stringify({ success: false, message: 'No valid action.' })
  ).setMimeType(ContentService.MimeType.JSON);
}

/*
  新順序：
  A: 員工編號 (id)
  B: 姓名 (empName)
  C: 部門 (department)
  D: 職稱 (title)
  E: 密碼 (pw)
  F: FolderID (folderId)
  G: 首次登入 (rawFirstLogin)
*/
function handleLogin(params) {
  const { employeeId, password } = params;
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    // [id, empName, department, title, pw, folderId, rawFirstLogin]
    const row = data[i];
    const [id, empName, department, title, pw, folderId, rawFirstLogin] = row;

    // 檢查帳密
    if (id.toString().trim() === employeeId.trim() &&
        pw.toString().trim() === password.trim()) {
      
      // 若空白 => '是'
      const firstLogin = (!rawFirstLogin || rawFirstLogin === '') ? '是' : rawFirstLogin;
      
      if (firstLogin === '是') {
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          needPasswordChange: true,
          message: '首次登入，請變更密碼'
        })).setMimeType(ContentService.MimeType.JSON);
      } else {
        // 若要前端也能顯示姓名、職稱 => 一併回傳
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          token: 'token_' + employeeId,
          department,
          folderId,
          name: empName,
          title,
          message: '登入成功'
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
  }
  // 若遍歷完，沒發現吻合 => 帳密錯誤
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    message: '帳號或密碼錯誤'
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleChangePassword(params) {
  const { employeeId, oldPassword, newPassword } = params;
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    // [id, empName, department, title, pw, folderId, rawFirstLogin]
    const row = data[i];
    const [id, empName, department, title, pw, folderId, rawFirstLogin] = row;

    // 檢查舊密碼
    if (id.toString().trim() === employeeId.trim() &&
        pw.toString().trim() === oldPassword.trim()) {
      
      // E 欄 => 密碼
      sheet.getRange(i + 1, 5).setValue(newPassword);

      // G 欄 => 改為 '否'
      sheet.getRange(i + 1, 7).setValue('否');
      
      return ContentService.createTextOutput(JSON.stringify({ success: true }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    message: '舊密碼不正確'
  })).setMimeType(ContentService.MimeType.JSON);
}

function generateSignedPdf(params) {
  const dataUrl = params.dataUrl;
  const folderId = params.folderId;
  const fileList = JSON.parse(params.fileList || '[]');

  const signatureBlob = Utilities.newBlob(
    Utilities.base64Decode(dataUrl.split(',')[1]),
    MimeType.PNG,
    'signature.png'
  );

  const now = new Date();
  const formattedDate = Utilities.formatDate(
    now,
    Session.getScriptTimeZone(),
    'yyyy/MM/dd HH:mm'
  );
  const weekDay = ['日','一','二','三','四','五','六'][now.getDay()];
  const displayDate = `${now.getFullYear() - 1911}年${String(now.getMonth()+1).padStart(2,'0')}月${String(now.getDate()).padStart(2,'0')}日（星期${weekDay}）`;

  const folder = DriveApp.getFolderById(folderId);
  const departmentName = folder.getName();

  // 複製 Word 樣板
  const docFile = DriveApp.getFileById(TEMPLATE_DOC_ID).makeCopy('簽核表_' + Date.now());
  const doc = DocumentApp.openById(docFile.getId());
  const body = doc.getBody();

  // 填入基本資訊
  body.replaceText('部門名稱：.*', '部門名稱：' + departmentName);
  body.replaceText('時間：.*', '時間：' + displayDate);

  // 插入檔案清單
  const tables = body.getTables();
  if (tables.length > 0 && fileList.length > 0) {
    const table = tables[0];
    while (table.getNumRows() > 1) table.removeRow(1);

    fileList.forEach(file => {
      const row = table.appendTableRow();
      row.appendTableCell(file.name);
      row.appendTableCell(file.date.split(' ')[0]); // 只要日期，不要時間
    });
  }

  // 插入簽名圖片
  const found = body.findText('部門主管簽章：');
  if (found) {
    const paragraph = found.getElement().getParent().asParagraph();
    paragraph.appendText('  ');
    const image = paragraph.appendInlineImage(signatureBlob);
    image.setWidth(200); // 你可以調整
    const timeNote = paragraph.appendText(` (簽署時間：${formattedDate})`);
    timeNote.setFontSize(10);
  }

  doc.saveAndClose();

  // 轉成 PDF
  const pdf = DriveApp.getFileById(docFile.getId()).getAs(MimeType.PDF);
  const final = DriveApp.getFolderById(OUTPUT_FOLDER_ID).createFile(
    pdf.setName('簽核表_' + displayDate)
  );
  // 清理 doc copy
  docFile.setTrashed(true);

  return ContentService.createTextOutput(
    JSON.stringify({
      success: true,
      url: final.getUrl(),
    })
  ).setMimeType(ContentService.MimeType.JSON);
}
